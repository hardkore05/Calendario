<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Calendario de Actividades</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f5f5f5; }
    header { background: #004c97; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
    h1 { font-size: 18px; margin: 0; }
    main { display: flex; flex-wrap: wrap; padding: 10px; gap: 10px; }
    section { background: white; border-radius: 8px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex: 1; min-width: 340px; }
    form .fila { display: flex; flex-direction: column; margin-bottom: 8px; }
    label { font-weight: bold; margin-bottom: 3px; font-size: 13px; }
    input, select, textarea, button { font-size: 13px; padding: 5px; }
    button { background: #004c97; color: white; border: none; cursor: pointer; border-radius: 5px; padding: 7px; }
    button:hover { background: #006ad1; }
    #login { text-align: center; padding: 40px; }
    #login input { margin: 5px; padding: 5px; width: 200px; }
    #error { color: red; }
    .oculto { display: none; }
    .botones-admin button { margin-right: 5px; }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="login">
    <h2>Acceso al Sistema</h2>
    <input type="number" id="cedula" placeholder="Ingrese su número de cédula" />
    <button id="loginBtn">Ingresar</button>
    <p id="error"></p>
  </div>

  <!-- APP -->
  <div id="app" style="display:none;">
    <header>
      <h1>Gestión de Actividades</h1>
      <button id="cerrarSesion">Cerrar sesión</button>
    </header>

    <main>
      <section id="formulario">
        <h2>Registrar Actividad</h2>
        <form id="formActividad">
          <div class="fila">
            <label>Oficina:</label>
            <select id="oficina" required>
              <option value="">Seleccione...</option>
              <option>Instancias de Participación</option>
              <option>Salud</option>
              <option>Educación</option>
              <option>Subsidio Bono C</option>
              <option>Casa Mujer Respiro</option>
              <option>Casa del Adulto Mayor</option>
              <option>Cultura y Deporte</option>
              <option>Ambiente</option>
              <option>Desarrollo Económico</option>
              <option>Área de Gestión de Desarrollo Local</option>
              <option>Enlace Social</option>
              <option>PYBA</option>
              <option>Alcaldía Local de Engativá</option>
              <option>Enlace de Participación</option>
            </select>
          </div>

          <div class="fila">
            <label>Responsable:</label>
            <input type="text" id="responsable" readonly />
          </div>

          <!-- META -->
          <div class="fila">
            <label>Meta:</label>
            <select id="meta" required>
              <option value="">Seleccione una meta...</option>
              <option>Fortalecer 100 organizaciones comunitarias a través de capacidades para promover acciones de corresponsabilidad en la gestión de la seguridad y la convivencia.</option>
    <option>Implementar 4 acciones formativas diferenciales para la promoción de la convivencia ciudadana.</option>
    <option>Vincular 4000 personas en acciones para la prevención del feminicidio y la violencia contra la mujer.</option>
    <option>Suministrar 4 dotaciones a organismos de seguridad.</option>
    <option>Fortalecer 4 programas de abordaje de conflictividad escolar para la convivencia con enfoque restaurativo.</option>
    <option>Fortalecer 8 actores comunitarios con herramientas y capacidades para la implementación de un enfoque restaurativo para la justicia y la convivencia.</option>
    <option>Implementar 4 proyectos comunitarios en la localidad, para la apropiación del Código Nacional de Seguridad y Convivencia Ciudadana.</option>
    <option>Ejecutar 4 programas comunitarios con enfoque restaurativo para el cuidado del espacio público y del medio ambiente.</option>
    <option>Realizar 4 acuerdos para la organización, la recuperación, el cuidado, el embellecimiento, la sostenibilidad, el mejoramiento y el aprovechamiento económico del espacio público.</option>
    <option>Intervenir 2.500 metros cuadrados de elementos del sistema de espacio público peatonal con acciones de construcción y/o conservación.</option>
    <option>Implementar 4 estrategias de seguridad y convivencia a través de gestores locales que permitan el uso y disfrute del espacio público.</option>
    <option>Beneficiar 3200 jóvenes con transferencias condicionadas y acompañamiento psicosocial para la promoción al acceso y permanencia a oportunidades de formación y empleabilidad.</option>
    <option>Atender 10.000 personas con apoyos que contribuyan al ingreso mínimo garantizado.</option>
    <option>Beneficiar 3650 personas mayores con apoyo económico tipo C.</option>
    <option>Habilitar 230 cupos para la atención de población en inseguridad alimentaria y nutricional del Distrito Capital, a través de comedores comunitarios.</option>
    <option>Implementar 4 programas de actividad física para el bienestar.</option>
    <option>Realizar 4 campañas de promoción de la salud física y mental.</option>
    <option>Beneficiar 400 personas mayores en programas de envejecimiento activo.</option>
    <option>Fortalecer 10 organizaciones de personas con discapacidad en la localidad.</option>
    <option>Vincular 1000 personas víctimas del conflicto armado en procesos de atención integral.</option>
    <option>Desarrollar 6 proyectos deportivos comunitarios.</option>
    <option>Realizar 4 eventos recreativos y deportivos por la inclusión.</option>
    <option>Formar 600 personas en los campos artísticos, interculturales, culturales y/o patrimoniales.</option>
    <option>Beneficiar 20 organizaciones artísticas y culturales con elementos entregados.</option>
    <option>Atender 900 animales en los programas de brigadas médicas, urgencias veterinarias y adopciones.</option>
    <option>Vincular 4000 personas en acciones educativas en temas de protección y bienestar animal.</option>
    <option>Esterilizar 8000 perros y gatos incluyendo los que están en condición de vulnerabilidad.</option>
    <option>Dotar 10 sedes educativas urbanas y rurales con recursos pedagógicos y/o tecnológicos.</option>
    <option>Beneficiar 250 personas con apoyo para la educación posmedia.</option>
    <option>Beneficiar 250 estudiantes con apoyo de sostenimiento para la permanencia en la educación posmedia.</option>
    <option>Fortalecer 100 unidades productivas.</option>
    <option>Implementar 4 procesos de formación para el empleo y emprendimiento.</option>
    <option>Otorgar 100 estímulos de apoyo al sector artístico y cultural.</option>
    <option>Beneficiar 10 colectivos u organizaciones recreodeportivas inscritas en el Banco que implementen iniciativas de carácter barrial con apoyos económicos.</option>
    <option>Beneficiar 11.200 personas en actividades recreo-deportivas comunitarias.</option>
    <option>Capacitar 600 personas en los campos deportivos.</option>
    <option>Realizar 20 eventos de promoción, circulación y apropiación de actividades artísticas, culturales y patrimoniales.</option>
    <option>Capacitar 600 personas en los campos artísticos, interculturales, culturales y/o patrimoniales.</option>
    <option>Beneficiar 20 organizaciones artísticas y culturales con elementos entregados.</option>
    <option>Atender 900 animales en los programas de brigadas médicas, urgencias veterinarias y adopciones.</option>
    <option>Vincular 4000 personas en acciones educativas en temas de protección y bienestar animal.</option>
    <option>Esterilizar 8000 perros y gatos incluyendo los que están en condición de vulnerabilidad.</option>
    <option>Dotar 10 sedes educativas urbanas y rurales con recursos pedagógicos y/o tecnológicos.</option>
    <option>Beneficiar 250 personas con apoyo para la educación posmedia.</option>
    <option>Beneficiar 250 estudiantes con apoyo de sostenimiento para la permanencia en la educación posmedia.</option>
    <option>Realizar 4 acciones para fortalecer las capacidades y/o habilidades técnicas y blandas de las personas de la localidad, con el fin de mejorar el acceso a oportunidades de empleo.</option>
    <option>Fortalecer 100 unidades productivas.</option>
    <option>Implementar 4 procesos de formación para el empleo y emprendimiento.</option>
    <option>Intervenir 20 parques vecinales y/o de bolsillo con acciones de mejoramiento, mantenimiento y/o dotación.</option>
    <option>Intervenir 1 equipamiento cultural con acciones de construcción, adecuación y/o dotación.</option>
    <option>Mantener 400 m² de jardinería.</option>
    <option>Mantener 2000 árboles en zona urbana.</option>
    <option>Generar 500 m² de áreas renaturalizadas.</option>
    <option>Implementar 16 procesos comunitarios de educación ambiental que promuevan la conservación de la biodiversidad y el agua.</option>
    <option>Capacitar 8000 personas en separación en la fuente y reciclaje.</option>
    <option>Intervenir 40 kilómetros-carril de malla vial urbana (local y/o intermedia) con acciones de construcción y/o conservación.</option>
    <option>Realizar 4 acciones efectivas para el fortalecimiento de las capacidades locales para la respuesta a emergencias y desastres.</option>
    <option>Dotar y/o acondicionar 8 unidades operativas orientadas a la atención de la primera infancia (Jardines Infantiles, Casas de Pensamiento Intercultural, Modalidad Espacios Rurales, Crecemos en la Ruralidad, Creciendo Juntos, Centros Amar, Centros Forjar).</option>
    <option>Operativizar 2 Centros de Acceso Comunitario en zonas rurales y/o apartadas y/o urbanas, con énfasis en Servicios TIC generados.</option>
    <option>Operativizar 2 Centros de Acceso Comunitario en zonas rurales y/o apartadas y/o urbanas, con énfasis en procesos de formación y desarrollo de competencias digitales.</option>
    <option>Fortalecer 200 Organizaciones, JAC e Instancias de participación ciudadana.</option>
    <option>Capacitar 1000 personas a través de procesos de formación para la participación de manera virtual y presencial.</option>
    <option>Desarrollar 4 acciones orientadas a la ciudadanía en el marco de la estrategia “Bogotaneidad”.</option>
    <option>Fortalecer 1 unidad de innovación pública y social a nivel local.</option>
    <option>Concertar e implementar 1 iniciativa de inversión local con los pueblos indígenas.</option>
    <option>Concertar e implementar 1 iniciativa de inversión local con las comunidades negras, afrocolombianas y palenqueras.</option>
    <option>Concertar e implementar 1 iniciativa de inversión local con las comunidades raizales.</option>
    <option>Rehabilitar 20 salones comunales y/o casas de participación.</option>
    <option>Dotar 40 organizaciones comunales.</option>
    <option>Fortalecer 30 medios comunitarios y alternativos.</option>
    <option>Implementar 4 programas comunitarios de cultura ciudadana.</option>
    <option>Ejecutar 4 proyectos comunitarios de convivencia.</option>
    <option>Fortalecer 8 actores sociales en mediación y conciliación.</option>
    <option>Suministrar 4 dotaciones tecnológicas para la seguridad y convivencia.</option>
    <option>No Aplica.</option>
  </select>
</div>
          
          <div class="fila"><label>Participantes:</label><input type="text" id="participantes"></div>
          <div class="fila"><label>Población Beneficiada:</label><input type="text" id="poblacion"></div>
          <div class="fila"><label>Ubicación (Dirección - Lugar):</label><input type="text" id="ubicacion"></div>
          <div class="fila"><label>Requerimientos Logísticos:</label><textarea id="requerimientos"></textarea></div>

          <div class="fila"><label>Fecha:</label><input type="date" id="fecha" required /></div>
          <div class="fila"><label>Hora inicio:</label><input type="time" id="horaInicio" required /></div>
          <div class="fila"><label>Hora fin:</label><input type="time" id="horaFin" required /></div>
          <div class="fila"><label>Descripción:</label><textarea id="descripcion" rows="2" required></textarea></div>

          <button type="submit" id="guardarBtn">Guardar Actividad</button>
        </form>
      </section>

      <section id="calendario">
        <div id="calendar"></div>
        <div id="detalleDia" class="oculto">
          <h3>Actividades del día seleccionado</h3>
          <ul id="listaEventos"></ul>
        </div>
      </section>
    </main>
  </div>

  <script>
    // =========================
    // USUARIOS AUTORIZADOS
    // =========================
    const usuarios = {
      "80772128": { nombre: "Víctor Hugo Huertas Prada", oficina: "Alcaldía Local de Engativá", rol: "admin" },
      "1057581626": { nombre: "Samuel Camacho", oficina: "Área de Gestión de Desarrollo Local", rol: "admin" },
      "1014201517": { nombre: "Daniel Rincón", oficina: "Cultura y Deporte", rol: "user" },
      "1019004954": { nombre: "Edgar Forero", oficina: "Instancias de Participación", rol: "user" },
      "1052380026": { nombre: "Sandra Tellez", oficina: "Salud", rol: "user" },
      "1032506186": { nombre: "Alexandra Bueno", oficina: "Educación", rol: "user" },
      "52046781": { nombre: "Deisy Villalba", oficina: "Subsidio Bono C", rol: "user" },
      "1014288855": { nombre: "Alejandra Bermudez", oficina: "Casa Mujer Respiro", rol: "user" },
      "1015405783": { nombre: "Leandro Ariza", oficina: "Casa del Adulto Mayor", rol: "user" },
      "79880521": { nombre: "Nicolás Rodríguez", oficina: "Cultura y Deporte", rol: "user" },
      "1014264461": { nombre: "Fernanda Villamil", oficina: "Ambiente", rol: "user" },
      "5660739": { nombre: "Cristian Pérez", oficina: "Desarrollo Económico", rol: "user" },
      "80017445": { nombre: "Fredy Amado", oficina: "Enlace Social", rol: "user" },
      "79803436": { nombre: "Jheison Barrios", oficina: "PYBA", rol: "user" },
      "1026285569": { nombre: "Paula Salgado", oficina: "Enlace de Participación", rol: "user" }
    };

    let usuario = null;

    // =========================
    // LOGIN
    // =========================
    document.getElementById("loginBtn").addEventListener("click", () => {
      const cedula = document.getElementById("cedula").value.trim();
      usuario = usuarios[cedula];

      if (usuario) {
        document.getElementById("login").style.display = "none";
        document.getElementById("app").style.display = "block";
        document.querySelector("header h1").textContent = `Bienvenido, ${usuario.nombre}`;
      } else {
        document.getElementById("error").textContent = "Cédula no autorizada.";
      }
    });

    // =========================
    // CERRAR SESIÓN
    // =========================
    document.getElementById("cerrarSesion").addEventListener("click", () => {
      location.reload();
    });

    // =========================
    // RESPONSABLES DE OFICINA
    // =========================
    const responsables = {
      "Instancias de Participación": "Edgar Forero",
      "Salud": "Sandra Tellez",
      "Educación": "Alexandra Bueno",
      "Subsidio Bono C": "Deisy Villalba",
      "Casa Mujer Respiro": "Alejandra Bermudez",
      "Casa del Adulto Mayor": "Leandro Ariza",
      "Cultura y Deporte": "Nicolás Rodríguez",
      "Ambiente": "Fernanda Villamil",
      "Desarrollo Económico": "Cristian Pérez",
      "Área de Gestión de Desarrollo Local": "Samuel Camacho",
      "Enlace Social": "Fredy Amado",
      "PYBA": "Jheison Barrios",
      "Alcaldía Local de Engativá": "Víctor Hugo Huertas Prada",
      "Enlace de Participación": "Paula Salgado"
    };

    document.getElementById("oficina").addEventListener("change", e => {
      document.getElementById("responsable").value = responsables[e.target.value] || "";
    });

    // =========================
    // INICIALIZAR CALENDARIO
    // =========================
    const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
      initialView: "dayGridMonth",
      locale: "es",
      selectable: true,
      height: "auto",
      dateClick: info => mostrarEventosDelDia(info.dateStr)
    });

    calendar.render();
    cargarEventos();

    // =========================
    // GUARDAR ACTIVIDAD
    // =========================
    document.getElementById("formActividad").addEventListener("submit", async e => {
      e.preventDefault();

      const evento = {
        title: `${document.getElementById("oficina").value} - ${document.getElementById("descripcion").value}`,
        start: `${document.getElementById("fecha").value}T${document.getElementById("horaInicio").value}`,
        end: `${document.getElementById("fecha").value}T${document.getElementById("horaFin").value}`,
        meta: document.getElementById("meta").value,
        participantes: document.getElementById("participantes").value,
        poblacion: document.getElementById("poblacion").value,
        ubicacion: document.getElementById("ubicacion").value,
        requerimientos: document.getElementById("requerimientos").value,
        oficina: document.getElementById("oficina").value,
        responsable: document.getElementById("responsable").value,
        creadoPor: usuario.nombre,
        fechaRegistro: new Date().toLocaleString("es-CO"),
        estado: "Pendiente",
        evaluado: false
      };

      const res = await fetch("/api/eventos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(evento)
      });
      const eventoGuardado = await res.json();

      calendar.addEvent({
        id: eventoGuardado._id,
        title: eventoGuardado.title,
        start: eventoGuardado.start,
        end: eventoGuardado.end,
        extendedProps: eventoGuardado
      });

      e.target.reset();
      alert("Actividad guardada exitosamente");
    });

    // =========================
    // MOSTRAR EVENTOS DEL DÍA
    // =========================
    async function mostrarEventosDelDia(fechaStr) {
      const lista = document.getElementById("listaEventos");
      const res = await fetch("/api/eventos");
      const eventos = (await res.json()).filter(e => e.start.startsWith(fechaStr));

      lista.innerHTML = "";
      if (eventos.length === 0) {
        lista.innerHTML = "<li>No hay actividades para este día.</li>";
      } else {
        eventos.forEach(e => {
          const li = document.createElement("li");
          li.innerHTML = `
  <b>${e.title}</b><br>
  Responsable: ${e.responsable}<br>
  Meta: ${e.meta || "-"}<br>
  Participantes: ${e.participantes || "-"}<br>
  Población: ${e.poblacion || "-"}<br>
  Ubicación: ${e.ubicacion || "-"}<br>
  Requerimientos: ${e.requerimientos || "-"}<br>
  Hora inicio: ${new Date(e.start).toLocaleTimeString("es-CO", { hour: "2-digit", minute: "2-digit" })}<br>
  Hora fin: ${new Date(e.end).toLocaleTimeString("es-CO", { hour: "2-digit", minute: "2-digit" })}<br>
  Registrado por: ${e.creadoPor}<br>
  Fecha registro: ${e.fechaRegistro}<br>
  Estado: <b>${e.estado}</b>
`;
          if (usuario.rol === "admin") {
            const divBtns = document.createElement("div");
            divBtns.className = "botones-admin";

            const btnAceptar = document.createElement("button");
            btnAceptar.textContent = "Aceptar";
            const btnRechazar = document.createElement("button");
            btnRechazar.textContent = "Rechazar";
            const btnEliminar = document.createElement("button");
            btnEliminar.textContent = "Eliminar";

            if (!e.evaluado) {
              btnAceptar.onclick = () => cambiarEstado(e._id, "Aceptado");
              btnRechazar.onclick = () => cambiarEstado(e._id, "Rechazado");
            } else {
              btnAceptar.disabled = true;
              btnRechazar.disabled = true;
            }

            btnEliminar.onclick = () => eliminarEvento(e._id);

            divBtns.append(btnAceptar, btnRechazar, btnEliminar);
            li.appendChild(divBtns);
          }

          lista.appendChild(li);
        });
      }

      document.getElementById("detalleDia").classList.remove("oculto");
    }

    // =========================
    // FUNCIONES AUXILIARES (BACKEND)
    // =========================
    async function cargarEventos() {
      const res = await fetch("/api/eventos");
      const eventos = await res.json();
      calendar.removeAllEvents();
      eventos.forEach(e => calendar.addEvent({
        id: e._id,
        title: e.title,
        start: e.start,
        end: e.end,
        extendedProps: e
      }));
    }

    async function cambiarEstado(id, nuevoEstado) {
      const res = await fetch(`/api/eventos/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ estado: nuevoEstado, evaluado: true })
      });
      if (res.ok) {
        alert(`Actividad ${nuevoEstado}`);
        cargarEventos();
      }
    }

    async function eliminarEvento(id) {
      if (!confirm("¿Desea eliminar esta actividad?")) return;
      const res = await fetch(`/api/eventos/${id}`, { method: "DELETE" });
      if (res.ok) {
        alert("Actividad eliminada");
        cargarEventos();
      }
    }
  </script>
</body>
</html>
